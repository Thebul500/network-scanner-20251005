name: Semgrep SAST

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  schedule:
    - cron: "0 3 * * 0"  # Sunday 3 AM UTC
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  issues: write

jobs:
  semgrep:
    name: Semgrep Scan
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep
    steps:
      - uses: actions/checkout@v4

      - name: Run Semgrep (SARIF)
        run: |
          semgrep scan \
            --config auto \
            --config p/security-audit \
            --config p/owasp-top-ten \
            --sarif \
            --output semgrep-results.sarif \
            --error
        continue-on-error: true

      - name: Run Semgrep (JSON for issue creation)
        run: |
          semgrep scan \
            --config auto \
            --config p/security-audit \
            --config p/owasp-top-ten \
            --json \
            --output semgrep-results.json
        continue-on-error: true

      - name: Upload SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep-results.sarif
        continue-on-error: true

      - name: Create issue for high/critical findings
        if: always()
        shell: python3 {0}
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          import json, os, subprocess, sys

          try:
              with open("semgrep-results.json") as f:
                  data = json.load(f)
          except (FileNotFoundError, json.JSONDecodeError):
              print("No results file found, skipping issue creation")
              sys.exit(0)

          severity_map = {
              "ERROR": "HIGH",
              "WARNING": "MEDIUM",
              "INFO": "LOW",
          }

          findings = []
          for r in data.get("results", []):
              sev = r.get("extra", {}).get("severity", "INFO")
              level = severity_map.get(sev, sev)
              if level not in ("HIGH", "CRITICAL"):
                  continue
              findings.append({
                  "rule": r.get("check_id", "unknown"),
                  "severity": level,
                  "file": r.get("path", "?"),
                  "line": r.get("start", {}).get("line", "?"),
                  "message": r.get("extra", {}).get("message", "No description"),
              })

          if not findings:
              print("No high/critical findings, no issue needed")
              sys.exit(0)

          title = f"Semgrep: {len(findings)} high/critical finding(s) detected"

          body_lines = [
              f"Semgrep found **{len(findings)} high/critical** security finding(s).",
              "",
              f"**Workflow run:** {os.environ['RUN_URL']}",
              "",
              "| Severity | File | Line | Rule | Description |",
              "|----------|------|------|------|-------------|",
          ]
          for finding in findings:
              msg = finding["message"].replace("\n", " ")[:120]
              body_lines.append(
                  f'| {finding["severity"]} | `{finding["file"]}` | {finding["line"]} | `{finding["rule"]}` | {msg} |'
              )
          body_lines += ["", "---", "*Auto-generated by Semgrep SAST workflow*"]
          body = "\n".join(body_lines)

          # Check for existing open issue with same title to avoid duplicates
          result = subprocess.run(
              ["gh", "issue", "list", "--repo", os.environ["REPO"],
               "--state", "open", "--search", title, "--json", "number,title"],
              capture_output=True, text=True
          )
          if result.returncode == 0:
              existing = json.loads(result.stdout)
              for issue in existing:
                  if issue["title"] == title:
                      subprocess.run(
                          ["gh", "issue", "comment", "--repo", os.environ["REPO"],
                           str(issue["number"]), "--body", body],
                      )
                      print(f"Updated existing issue #{issue['number']}")
                      sys.exit(0)

          # Create new issue
          subprocess.run(
              ["gh", "issue", "create", "--repo", os.environ["REPO"],
               "--title", title, "--body", body, "--label", "security"],
          )
          print(f"Created new issue: {title}")
